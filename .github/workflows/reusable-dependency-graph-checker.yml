name: Dependency Graph Check
run-name: Verifying Dependency Graph is Up to Date

on:
  workflow_call:
    outputs:
      status:
        description: "Status of the dependency graph check"
        value: ${{ jobs.verify-dependency-graph.outputs.status }}

jobs:
  verify-dependency-graph:
    name: Verify Dependency Graph
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Verify Dependency Graph
        id: check
        run: |
          set -o pipefail
          if ! ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand 2>&1 | tee dep-graph-output.txt; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Failed to generate dependency graph (build failure)"
            exit 1
          fi
          
          cp build/reports/dependency-graph.gv docs/dependency-graph.gv
          
          if ! git ls-files --error-unmatch docs/dependency-graph.gv > /dev/null 2>&1; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Dependency graph file is not tracked in git"
            exit 1
          fi
          
          if git diff --exit-code docs/dependency-graph.gv >> dep-graph-output.txt 2>&1; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Dependency graph is current"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Dependency graph is out of sync"
            exit 1
          fi
        continue-on-error: true

      - name: Upload Dependency Graph Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph-report
          path: dep-graph-output.txt
          retention-days: 90

      - name: Create Issue if Out of Sync
        if: steps.check.outputs.status != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            // Close previous issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check-dep-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'dependency-graph-report');
            const artifactUrl = artifact 
              ? `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            const body = `## Dependency Graph Out of Sync (1 issue)

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Download Report
            
            [ðŸ“¥ Download full report](${artifactUrl}) - GitHub will provide a zip file containing \`dep-graph-output.txt\`

            ### Problems Found

            - [ ] Committed dependency graph (docs/dependency-graph.gv) does not match current module structure

            ### How to Fix

            \`\`\`bash
            ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand
            cp build/reports/dependency-graph.gv docs/dependency-graph.gv
            git add docs/dependency-graph.gv docs/project_dependencies_graph.png
            git commit -m "Update dependency graph"
            \`\`\`

            ### Resources

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [GRADLE_TASKS.md](${context.payload.repository.html_url}/blob/master/docs/GRADLE_TASKS.md)

            ---
            _Auto-generated by Monthly Master Sanity Check. This issue will be auto-closed when the problem is resolved._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Dependency Graph Out of Sync (1 issue)',
              labels: ['sanity-check-dep-graph'],
              body: body
            });

      - name: Close Previous Issues if Success
        if: steps.check.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check-dep-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            console.log('âœ… Dependency graph check passed - no issue needed');

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Dependency Graph Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.status }}" == "success" ]; then
            echo "âœ… **Dependency graph is up to date!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dependency graph is out of sync**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub issue has been created with the details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Download Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [Download dependency-graph-report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi
