name: Dependency Graph Check
run-name: Verifying Dependency Graph is Up to Date

on:
  workflow_call:
    outputs:
      status:
        description: "Status of the dependency graph check"
        value: ${{ jobs.verify-dependency-graph.outputs.status }}

jobs:
  verify-dependency-graph:
    name: Verify Dependency Graph
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Verify Dependency Graph
        id: check
        continue-on-error: true
        run: |
          set -o pipefail
          
          # Try to generate the dependency graph
          if ! ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand 2>&1 | tee dep-graph-output.txt; then
            # Build failed - check couldn't complete
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Failed to generate dependency graph (build failure)"
            exit 1
          fi
          
          # Check if dependency graph file exists in git
          if ! git ls-files --error-unmatch docs/assets/dependency-graph.gv > /dev/null 2>&1; then
            # Graph not tracked - this is a check failure (config issue)
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Dependency graph file is not tracked in git"
            exit 1
          fi
          
          # Copy generated graph to docs location
          cp build/reports/dependency-graph.gv docs/assets/dependency-graph.gv
          
          # Check if it matches the committed version
          if git diff --exit-code docs/assets/dependency-graph.gv >> dep-graph-output.txt 2>&1; then
            # No difference - check passed
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Dependency graph is current"
          else
            # Graph is out of sync - check succeeded but found issues
            echo "status=success-issues" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dependency graph is out of sync"
          fi

      - name: Upload Dependency Graph Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph-report
          path: dep-graph-output.txt
          retention-days: 90

      - name: Create Issue if Check Failed
        if: steps.check.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Close previous issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'dependency-graph-report');
            const artifactUrl = artifact 
              ? `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            // Extract "What went wrong" section from output
            let errorDetails = 'See full report for details';
            try {
              const output = fs.readFileSync('dep-graph-output.txt', 'utf8');
              const whatWentWrongMatch = output.match(/\* What went wrong:\n([\s\S]*?)(?:\n\* Try:|$)/);
              if (whatWentWrongMatch) {
                errorDetails = whatWentWrongMatch[1].trim();
              }
            } catch (error) {
              // Fallback to generic message
            }
            
            const body = `## Dependency Graph Check Failed to Complete

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### What Went Wrong

            \`\`\`
            ${errorDetails}
            \`\`\`

            ### Download Report
            
            [ðŸ“¥ Download full report](${artifactUrl}) - GitHub will provide a zip file containing \`dep-graph-output.txt\`

            ### How to Fix

            Resolve the underlying build issue, then run:

            \`\`\`bash
            ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand
            \`\`\`

            ### Resources

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [GRADLE_TASKS.md](${context.payload.repository.html_url}/blob/master/docs/GRADLE_TASKS.md)

            ---
            _Auto-generated by Monthly Master Sanity Check. This issue will be auto-closed when the problem is resolved._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Dependency Graph Check Failed to Complete',
              labels: ['modules-dependencies-graph'],
              body: body
            });

      - name: Create Issue if Out of Sync
        if: steps.check.outputs.status == 'success-issues'
        uses: actions/github-script@v7
        with:
          script: |
            // Close previous issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'dependency-graph-report');
            const artifactUrl = artifact 
              ? `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            const body = `## Dependency Graph Out of Sync (1 issue)

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Download Report
            
            [ðŸ“¥ Download full report](${artifactUrl}) - GitHub will provide a zip file containing \`dep-graph-output.txt\`

            ### Problems Found

            - [ ] Committed dependency graph (docs/assets/dependency-graph.gv) does not match current module structure

            ### How to Fix

            \`\`\`bash
            ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand
            cp build/reports/dependency-graph.gv docs/assets/dependency-graph.gv
            git add docs/assets/dependency-graph.gv docs/assets/project_dependencies_graph.png
            git commit -m "Update dependency graph"
            \`\`\`

            ### Resources

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [GRADLE_TASKS.md](${context.payload.repository.html_url}/blob/master/docs/GRADLE_TASKS.md)

            ---
            _Auto-generated by Monthly Master Sanity Check. This issue will be auto-closed when the problem is resolved._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Dependency Graph Out of Sync (1 issue)',
              labels: ['modules-dependencies-graph'],
              body: body
            });

      - name: Close Previous Issues if Success
        if: steps.check.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            console.log('âœ… Dependency graph check passed - no issue needed');

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Dependency Graph Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          case "${{ steps.check.outputs.status }}" in
            "success")
              echo "âœ… **Dependency graph is up to date!**" >> $GITHUB_STEP_SUMMARY
              ;;
            "success-issues")
              echo "âš ï¸ **Dependency graph is out of sync**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "A GitHub issue has been created with the details." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ Download Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [Download dependency-graph-report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
              ;;
            "failure")
              echo "âŒ **Check failed to complete**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The dependency graph check could not run due to a build or configuration error." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ Download Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [Download dependency-graph-report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
