name: Android Verification
run-name: Running Android Verifications
on:
  pull_request:
    branches: [ "master", "develop" ]
    paths-ignore:
      - '**.md'
      - '**.png'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  ktlint-check:
    name: Ktlint Check
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Run ktlintCheck
        run: ./gradlew ktlintCheck

  verify-module-dependencies:
    name: Verify Module Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Verify Module Dependencies
        run: |
          # Run assertions for both mobile and TV apps
          ./gradlew :android:mobile:app:assertModuleGraph --no-configure-on-demand
          ./gradlew :android:tv:app:assertModuleGraph --no-configure-on-demand

      - name: Install Graphviz
        run: sudo apt-get install -y graphviz

      - name: Verify Dependency Graph Is Current
        run: |
          # Generate the unified dependency graph
          ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand
          
          # Check if the generated graph differs from committed version
          if ! git diff --exit-code docs/project_dependencies_graph.png; then
            echo "❌ ERROR: Dependency graph is out of sync!"
            echo ""
            echo "The inter-modules dependency graph generated from this PR does not match the current one."
            echo "Please generate it locally for careful examination and push it to the branch if it matches the intention of this PR."
            echo ""
            echo "To update the graph:"
            echo "  1. Run: ./gradlew generateUnifiedDependencyGraph"
            echo "  2. Review the changes in: docs/project_dependencies_graph.png"
            echo "  3. If correct, commit and push the updated graph"
            echo ""
            exit 1
          fi
          
          echo "✅ Dependency graph is current and matches module structure"

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest

      - name: Generate Unit Tests Report
        uses: asadmansr/android-test-report-action@v1.2.0
        if: ${{ always() }}
