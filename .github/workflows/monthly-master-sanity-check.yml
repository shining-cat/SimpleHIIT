name: Monthly Master Sanity Check
run-name: Running Monthly Master Sanity Check

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  verify-module-dependencies:
    name: Verify Module Dependencies
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Verify Module Dependencies
        id: check
        run: |
          if ./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph --no-configure-on-demand; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Module dependencies are correct"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "‚ùå Module dependency violations found"
            exit 1
          fi
        continue-on-error: true

  verify-dependency-graph:
    name: Verify Dependency Graph
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Verify Dependency Graph
        id: check
        run: |
          if ! ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "‚ùå Failed to generate dependency graph (build failure)"
            exit 1
          fi
          
          cp build/reports/dependency-graph.gv docs/dependency-graph.gv
          
          if ! git ls-files --error-unmatch docs/dependency-graph.gv > /dev/null 2>&1; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "‚ùå Dependency graph file is not tracked in git"
            exit 1
          fi
          
          if git diff --exit-code docs/dependency-graph.gv; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Dependency graph is current"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "‚ùå Dependency graph is out of sync"
            exit 1
          fi
        continue-on-error: true

  check-deprecations:
    name: Check Deprecations
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      has_warnings: ${{ steps.check.outputs.has_warnings }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Check for Deprecations
        id: check
        run: |
          set +e
          ./gradlew clean assembleDebug --warning-mode all 2>&1 | tee build-output.txt
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            echo "‚ùå Build failed (exit code: $BUILD_EXIT_CODE)"
            exit 1
          fi
          
          if grep -i "deprecat" build-output.txt; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "has_warnings=true" >> $GITHUB_OUTPUT
            echo "‚ùå Deprecation warnings found"
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No deprecation warnings"
          fi
        continue-on-error: true

      - name: Upload Build Output
        if: steps.check.outputs.status == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: deprecation-warnings
          path: build-output.txt
          retention-days: 90

  report-module-dependencies:
    name: Report Module Dependencies Issues
    runs-on: ubuntu-latest
    needs: verify-module-dependencies
    if: needs.verify-module-dependencies.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'module-dependencies'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Module Dependencies Violation Detected

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Issues Found

            - Module dependency rules are being violated on the master branch
            - Run locally to reproduce: \`./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph\`

            ### Resources

            - **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Documentation:** [MODULE_DEPENDENCIES.md](${context.payload.repository.html_url}/blob/master/docs/MODULE_DEPENDENCIES.md)

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üî¥ Master Sanity Check: Module Dependencies Violation',
              labels: ['sanity-check', 'module-dependencies', 'bug'],
              assignees: ['shining-cat'],
              body: body
            });

  report-dependency-graph:
    name: Report Dependency Graph Issues
    runs-on: ubuntu-latest
    needs: verify-dependency-graph
    if: needs.verify-dependency-graph.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'dependency-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Dependency Graph Out of Sync

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Issues Found

            - Committed dependency graph (docs/dependency-graph.gv) does not match current module structure
            - Run locally to regenerate: \`./gradlew generateUnifiedDependencyGraph && cp build/reports/dependency-graph.gv docs/dependency-graph.gv\`

            ### Resources

            - **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Documentation:** [GRADLE_TASKS.md](${context.payload.repository.html_url}/blob/master/docs/GRADLE_TASKS.md)

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üü° Master Sanity Check: Dependency Graph Out of Sync',
              labels: ['sanity-check', 'dependency-graph', 'documentation'],
              assignees: ['shining-cat'],
              body: body
            });

  report-deprecations:
    name: Report Deprecation Issues
    runs-on: ubuntu-latest
    needs: check-deprecations
    if: needs.check-deprecations.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'deprecations'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue for Build Failure
        if: needs.check-deprecations.outputs.has_warnings == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Build Failure During Deprecation Check

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ‚ö†Ô∏è **Critical Issue** - Master branch should always build successfully.

            ### Issues Found

            - Build failed before deprecation checking could complete
            - Indicates a compilation or configuration error in the master branch
            - Run locally to reproduce: \`./gradlew clean assembleDebug --warning-mode all\`

            ### Resources

            - **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Build Output Artifact:** [Download deprecation-warnings](${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts)
            - **Documentation:** [DEPRECATION_CHECKER.md](${context.payload.repository.html_url}/blob/master/docs/DEPRECATION_CHECKER.md)

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üî¥ Master Sanity Check: Build Failure',
              labels: ['sanity-check', 'deprecations', 'bug'],
              assignees: ['shining-cat'],
              body: body
            });

      - name: Create Issue for Deprecation Warnings
        if: needs.check-deprecations.outputs.has_warnings == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Deprecation Warnings Detected

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Issues Found

            - Usage of deprecated APIs, libraries, or Gradle features detected
            - Run locally to reproduce: \`./gradlew clean assembleDebug --warning-mode all\`

            ### Resources

            - **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Build Output Artifact:** [Download deprecation-warnings](${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts)
            - **Documentation:** [DEPRECATION_CHECKER.md](${context.payload.repository.html_url}/blob/master/docs/DEPRECATION_CHECKER.md)

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üü† Master Sanity Check: Deprecation Warnings Detected',
              labels: ['sanity-check', 'deprecations', 'maintenance'],
              assignees: ['shining-cat'],
              body: body
            });
