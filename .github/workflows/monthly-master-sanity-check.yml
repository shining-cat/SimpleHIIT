name: Monthly Master Sanity Check
run-name: Running Monthly Master Sanity Check

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  verify-module-dependencies:
    name: Verify Module Dependencies
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Verify Module Dependencies
        id: check
        run: |
          if ./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph --no-configure-on-demand; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Module dependencies are correct"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Module dependency violations found"
            exit 1
          fi
        continue-on-error: true

  verify-dependency-graph:
    name: Verify Dependency Graph
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Verify Dependency Graph
        id: check
        run: |
          ./gradlew generateUnifiedDependencyGraph --no-configure-on-demand
          cp build/reports/dependency-graph.gv docs/dependency-graph.gv
          
          if ! git ls-files --error-unmatch docs/dependency-graph.gv > /dev/null 2>&1; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Dependency graph file is not tracked in git"
            exit 1
          fi
          
          if git diff --exit-code docs/dependency-graph.gv; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Dependency graph is current"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Dependency graph is out of sync"
            exit 1
          fi
        continue-on-error: true

  check-deprecations:
    name: Check Deprecations
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      has_warnings: ${{ steps.check.outputs.has_warnings }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Check for Deprecations
        id: check
        run: |
          ./gradlew clean assembleDebug --warning-mode all 2>&1 | tee build-output.txt
          if grep -i "deprecat" build-output.txt; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "has_warnings=true" >> $GITHUB_OUTPUT
            echo "âŒ Deprecation warnings found"
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            echo "âœ… No deprecation warnings"
          fi
        continue-on-error: true

      - name: Upload Build Output
        if: steps.check.outputs.has_warnings == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deprecation-warnings
          path: build-output.txt
          retention-days: 90

  report-module-dependencies:
    name: Report Module Dependencies Issues
    runs-on: ubuntu-latest
    needs: verify-module-dependencies
    if: needs.verify-module-dependencies.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'module-dependencies'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Module Dependencies Violation Detected

            The monthly master sanity check has detected module dependency violations.

            **Check Date:** ${new Date().toISOString().split('T')[0]}
            **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### What This Means

            The module dependency rules defined in the project are being violated on the master branch.

            ### Action Required

            1. Review the workflow run for details
            2. Run locally: \`./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph\`
            3. Fix any violations
            4. Verify changes with a PR

            ### Reference

            See [MODULE_DEPENDENCIES.md](${context.payload.repository.html_url}/blob/master/docs/MODULE_DEPENDENCIES.md) for dependency rules.

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”´ Master Sanity Check: Module Dependencies Violation',
              labels: ['sanity-check', 'module-dependencies', 'bug'],
              assignees: ['shining-cat'],
              body: body
            });

  report-dependency-graph:
    name: Report Dependency Graph Issues
    runs-on: ubuntu-latest
    needs: verify-dependency-graph
    if: needs.verify-dependency-graph.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'dependency-graph'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Dependency Graph Out of Sync

            The monthly master sanity check has detected that the dependency graph is not current.

            **Check Date:** ${new Date().toISOString().split('T')[0]}
            **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### What This Means

            The committed dependency graph (docs/dependency-graph.gv) does not match the current module structure.

            ### Action Required

            1. Run locally: \`./gradlew generateUnifiedDependencyGraph\`
            2. Copy: \`cp build/reports/dependency-graph.gv docs/dependency-graph.gv\`
            3. Review the changes in docs/dependency-graph.gv
            4. Commit and push if changes are expected: \`git add docs/dependency-graph.gv docs/project_dependencies_graph.png\`
            5. Investigate why the graph was not updated with the last module change

            ### Reference

            See [GRADLE_TASKS.md](${context.payload.repository.html_url}/blob/master/docs/GRADLE_TASKS.md) for graph generation instructions.

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸŸ¡ Master Sanity Check: Dependency Graph Out of Sync',
              labels: ['sanity-check', 'dependency-graph', 'documentation'],
              assignees: ['shining-cat'],
              body: body
            });

  report-deprecations:
    name: Report Deprecation Issues
    runs-on: ubuntu-latest
    needs: check-deprecations
    if: needs.check-deprecations.outputs.status == 'failure'
    permissions:
      issues: write
    
    steps:
      - name: Close Previous Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sanity-check', 'deprecations'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Deprecation Warnings Detected

            The monthly master sanity check has detected deprecation warnings in the codebase.

            **Check Date:** ${new Date().toISOString().split('T')[0]}
            **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### What This Means

            The build process has detected usage of deprecated APIs, libraries, or Gradle features.

            ### Action Required

            1. Download the deprecation-warnings artifact from the workflow run
            2. Review the deprecation warnings
            3. Plan migration to non-deprecated alternatives
            4. Update dependencies if needed

            ### Reference

            See [DEPRECATION_CHECKER.md](${context.payload.repository.html_url}/blob/master/docs/DEPRECATION_CHECKER.md) for more information about handling deprecations.

            ---
            _This issue was automatically created by the Monthly Master Sanity Check workflow._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸŸ  Master Sanity Check: Deprecation Warnings Detected',
              labels: ['sanity-check', 'deprecations', 'maintenance'],
              assignees: ['shining-cat'],
              body: body
            });
