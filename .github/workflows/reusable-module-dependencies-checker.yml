name: Module Dependencies Check
run-name: Verifying Module Dependencies

on:
  workflow_call:
    outputs:
      status:
        description: "Status of the module dependencies check"
        value: ${{ jobs.verify-module-dependencies.outputs.status }}

jobs:
  verify-module-dependencies:
    name: Verify Module Dependencies
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Verify Module Dependencies
        id: check
        continue-on-error: true
        run: |
          set -o pipefail
          
          # Run the check and capture exit code
          if ./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph --no-configure-on-demand 2>&1 | tee module-deps-output.txt; then
            # Gradle task succeeded - no violations
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Module dependencies are correct"
          else
            # Gradle task failed - determine if it's configuration failure or violations found
            if grep -q "Could not determine the dependencies\|Could not create task" module-deps-output.txt; then
              # Configuration failure (e.g., dependency cycle)
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "âŒ Failed to run module dependency check (configuration error)"
              exit 1
            elif grep -q "Execution failed for task.*assertAllowedModuleDependencies\|Execution failed for task.*assertModuleGraph" module-deps-output.txt; then
              # Task execution completed but found violations
              echo "status=success-issues" >> $GITHUB_OUTPUT
              echo "âš ï¸ Module dependency violations found"
            else
              # Unknown failure
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "âŒ Failed to run module dependency check (unknown error)"
              exit 1
            fi
          fi

      - name: Upload Module Dependencies Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: module-dependencies-report
          path: module-deps-output.txt
          retention-days: 90

      - name: Create Issue if Check Failed
        if: steps.check.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Close previous issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-violation'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            
            // Get artifact URL
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'module-dependencies-report');
            const artifactUrl = artifact 
              ? `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            // Extract "What went wrong" section from output
            let errorDetails = 'See full report for details';
            try {
              const output = fs.readFileSync('module-deps-output.txt', 'utf8');
              const whatWentWrongMatch = output.match(/\* What went wrong:\n([\s\S]*?)(?:\n\* Try:|$)/);
              if (whatWentWrongMatch) {
                errorDetails = whatWentWrongMatch[1].trim();
              }
            } catch (error) {
              // Fallback to generic message
            }
            
            const body = `## Module Dependencies Check Failed to Complete

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### What Went Wrong

            \`\`\`
            ${errorDetails}
            \`\`\`

            ### Download Report
            
            [ðŸ“¥ Download full report](${artifactUrl}) - GitHub will provide a zip file containing \`module-deps-output.txt\`

            ### How to Reproduce Locally

            \`\`\`bash
            ./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph --no-configure-on-demand
            \`\`\`

            ### Resources

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [MODULE_DEPENDENCIES.md](${context.payload.repository.html_url}/blob/master/docs/MODULE_DEPENDENCIES.md)

            ---
            _Auto-generated by Monthly Master Sanity Check. This issue will be auto-closed when the problem is resolved._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Module Dependencies Check Failed to Complete',
              labels: ['modules-dependencies-violation'],
              body: body
            });

      - name: Create Issue if Issues Found
        if: steps.check.outputs.status == 'success-issues'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Close previous issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-violation'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            
            // Get artifact URL
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'module-dependencies-report');
            const artifactUrl = artifact 
              ? `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            // Read and parse output
            let problemCount = 0;
            let checklist = '';
            
            try {
              const output = fs.readFileSync('module-deps-output.txt', 'utf8');
              const lines = output.split('\n');
              
              for (const line of lines) {
                if (line.includes('FAILURE') || line.includes('violation') || line.includes('ERROR')) {
                  problemCount++;
                  checklist += `- [ ] ${line.trim()}\n`;
                }
              }
              
              if (problemCount === 0) {
                problemCount = 1;
                checklist = '- [ ] Module dependency rules violated (see full report for details)\n';
              }
            } catch (error) {
              problemCount = 1;
              checklist = '- [ ] Module dependency check failed (see full report for details)\n';
            }
            
            const body = `## Module Dependencies Violation (${problemCount} issue${problemCount > 1 ? 's' : ''})

            **Check Date:** ${new Date().toISOString().split('T')[0]}

            ### Download Report
            
            [ðŸ“¥ Download full report](${artifactUrl}) - GitHub will provide a zip file containing \`module-deps-output.txt\`

            ### Problems Found

            ${checklist}

            ### How to Reproduce Locally

            \`\`\`bash
            ./gradlew :android:mobile:app:assertModuleGraph :android:tv:app:assertModuleGraph --no-configure-on-demand
            \`\`\`

            ### Resources

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [MODULE_DEPENDENCIES.md](${context.payload.repository.html_url}/blob/master/docs/MODULE_DEPENDENCIES.md)

            ---
            _Auto-generated by Monthly Master Sanity Check. This issue will be auto-closed when the problem is resolved._`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Module Dependencies Violation (${problemCount} issue${problemCount > 1 ? 's' : ''})`,
              labels: ['modules-dependencies-violation'],
              body: body
            });

      - name: Close Previous Issues if Success
        if: steps.check.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['modules-dependencies-violation'],
              state: 'open'
            });
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }
            console.log('âœ… Module dependencies check passed - no issue needed');

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Module Dependencies Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          case "${{ steps.check.outputs.status }}" in
            "success")
              echo "âœ… **Module dependency rules are correctly enforced!**" >> $GITHUB_STEP_SUMMARY
              ;;
            "success-issues")
              echo "âš ï¸ **Module dependency violations found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "A GitHub issue has been created with the details." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ Download Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [Download module-dependencies-report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
              ;;
            "failure")
              echo "âŒ **Check failed to complete**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The module dependencies check could not run due to a build or configuration error." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ Download Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [Download module-dependencies-report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
